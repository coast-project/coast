import SConsider, os, fnmatch, shutil
from stat import *

Import('*')

def ModifyConfigFiles(env, searchReplace=[], files=[]):
    for file in files:
        fname = file.abspath
        if os.path.isfile(fname):
            oldmode=os.stat(fname).st_mode
            ## set writable
            os.chmod(fname, oldmode | S_IWUSR)
            ## replace tokens in file
            SConsider.replaceRegexInFile(fname, searchReplace)
            os.chmod(fname, oldmode)

def setUp(target, source, env):
    env['ENV']['COAST_USE_MMAP_STREAMS'] = "0"

    targetDir = env['BASEOUTDIR'].Dir(env['RELTARGETDIR'])
    tmppath = targetDir.Dir('tmp').abspath
    for d in [tmppath,targetDir.Dir(os.path.join('config','rotate')).abspath]:
        if os.path.isdir(d):
            shutil.rmtree(d)
        try:
            os.makedirs(d)
        except oserror: pass
    searchReplace = [
        (r"##LOGDIR##", tmppath),
        (r"##ROTATEDIR##", tmppath),
    ]
    ModifyConfigFiles(env, searchReplace, SConsider.findFiles([targetDir.Dir('config').abspath],['.any']))

def tearDown(target, source, env):
    dir = env['BASEOUTDIR'].Dir(env['RELTARGETDIR']).Dir('config')
    for root, dirs, files in os.walk(dir.abspath):
        for f in files:
            if fnmatch.fnmatch(f, '*.log*'):
                os.unlink(os.path.join(root, f))

buildSettings = {
    packagename : {
        'linkDependencies' : ['CoastAppLog', 'testfwWDBase'],
        'sourceFiles'      : SConsider.listFiles(['*.cpp']),
        'targetType'       : 'ProgramTest',
        'copyFiles' : [
            (SConsider.listFiles(['config/*.any']), S_IRUSR | S_IRGRP | S_IROTH),
        ],
        'runConfig' : {
            'setUp': setUp,
            'tearDown': tearDown,
        },
    }
}

SConsider.createTargets(packagename, buildSettings)

#-----------------------------------------------------------------------------------------------------
# Copyright (c) 2009, Peter Sommerlad and IFS Institute for Software at HSR Rapperswil, Switzerland
# All rights reserved.
#
# This library/application is free software; you can redistribute and/or modify it under the terms of
# the license that is included with this library/application in the file license.txt.
#-----------------------------------------------------------------------------------------------------

{
	/DLL {
		CoastAppLog
		CoastDataAccess
		CoastRenderers
	}
	/Modules {
		ActionsModule
		RenderersModule
		OracleModule
		DataAccessImplsModule
		MappersModule
		AppLogModule
		ServersModule
	}

	/Servers {}
	# uncomment the server slot for enabling TimeLogging
	/Server	Server

	/Actions {
		/CallDataAccessAction	{ CallDA }
	}
	/Renderers {
		/SwitchRenderer 		{ Switch }
		/ContextLookupRenderer 	{ Lookup }
	}
	/OracleModule {
		/ConnectionPool {
			/ParallelQueries		4
			/CloseConnectionTimeout	20
		}
	}

	/DataAccessImpls {
		/OracleDAImpl {
			/SifsCoastOrcl {
				SelectEmployees
				SelectEmployeesTitlesOnce
				SPMaxSalary
				SPExecute
				LoadOratestSchema
			}
		}
		/MapperTestDAImpl {
			/SPSlotTest {
				SPRenderedParamTest
			}
		}
	}

	/Mappers {
		/Input {
			/ParameterMapper {
				/SifsCoastOrcl {
					/SelectEmployees {
						SelectEmployeesTitlesOnce
					}
					LoadOratestSchema
				}
			}
			/OracleSPMapper {
				/SifsCoastOrclSP {
					SPMaxSalary
					SPExecute
				}
				/SPSlotTest {
					SPRenderedParamTest
				}
			}
		}
		/Output {
			/ResultMapper {
				/PutResultMapper {
					/SPSlotTest {
						SPRenderedParamTest
					}
				}
				/OracleDAImpl {
					SelectEmployees
					SelectEmployeesTitlesOnce
					SPMaxSalary
					SPExecute
					LoadOratestSchema
				}
			}
		}
	}

######## Test specific section ########

	/RunOnly {
	}
	/TestCases {
		/SelectEmployeesTest {
			/TheAction {
				/CallDA 	SelectEmployees
			}
			/Result {
				/TmpStore {
					/SelectEmployees {
						/Query	"SELECT ename, job FROM emp"
						/QueryCount 14
						/QueryResult	{
						  {
						    /ENAME "SMITH"
						    /JOB "CLERK"
						  }
						  {
						    /ENAME "ALLEN"
						    /JOB "SALESMAN"
						  }
						  {
						    /ENAME "WARD"
						    /JOB "SALESMAN"
						  }
						  {
						    /ENAME "JONES"
						    /JOB "MANAGER"
						  }
						  {
						    /ENAME "MARTIN"
						    /JOB "SALESMAN"
						  }
						  {
						    /ENAME "BLAKE"
						    /JOB "MANAGER"
						  }
						  {
						    /ENAME "CLARK"
						    /JOB "MANAGER"
						  }
						  {
						    /ENAME "SCOTT"
						    /JOB "ANALYST"
						  }
						  {
						    /ENAME "KING"
						    /JOB "PRESIDENT"
						  }
						  {
						    /ENAME "TURNER"
						    /JOB "SALESMAN"
						  }
						  {
						    /ENAME "ADAMS"
						    /JOB "CLERK"
						  }
						  {
						    /ENAME "JAMES"
						    /JOB "CLERK"
						  }
						  {
						    /ENAME "FORD"
						    /JOB "ANALYST"
						  }
						  {
						    /ENAME "MILLER"
						    /JOB "CLERK"
						  }
						}
						/QuerySource	"//sifs-coast1.hsr.ch:1521/orcl"
					}
				}
			}
		}
		/SelectEmployeesTitlesOnceTest {
			/TheAction {
				/CallDA 	SelectEmployeesTitlesOnce
			}
			/Result {
				/TmpStore {
					/SelectEmployeesTitlesOnce {
						/Query	"SELECT ename, job FROM emp"
						/QueryCount 14
						/QueryTitles {
							/ENAME	0
							/JOB	1
						}
						/QueryResult	{
						  {
						    "SMITH"
						    "CLERK"
						  }
						  {
						    "ALLEN"
						    "SALESMAN"
						  }
						  {
						    "WARD"
						    "SALESMAN"
						  }
						  {
						    "JONES"
						    "MANAGER"
						  }
						  {
						    "MARTIN"
						    "SALESMAN"
						  }
						  {
						    "BLAKE"
						    "MANAGER"
						  }
						  {
						    "CLARK"
						    "MANAGER"
						  }
						  {
						    "SCOTT"
						    "ANALYST"
						  }
						  {
						    "KING"
						    "PRESIDENT"
						  }
						  {
						    "TURNER"
						    "SALESMAN"
						  }
						  {
						    "ADAMS"
						    "CLERK"
						  }
						  {
						    "JAMES"
						    "CLERK"
						  }
						  {
						    "FORD"
						    "ANALYST"
						  }
						  {
						    "MILLER"
						    "CLERK"
						  }
						}
						/QuerySource	"//sifs-coast1.hsr.ch:1521/orcl"
					}
				}
			}
		}
		/ParamTest {
			/TheAction {
				/CallDA 	SPSlotTest
			}
			/Result {
				/TmpStore {
					/SPSlotTest {
						/SPName		ourSPName
						/Param1		first
						/SPNameNativ		ourSPName
					}
				}
			}
		}
		/RenderedParamTest {
			/TmpStore {
				/P1	theContextParam
			}
			/TheAction {
				/CallDA 	SPRenderedParamTest
			}
			/Result {
				/TmpStore {
					/SPSlotTest {
						/SPName		ourSPName
						/Param1		theContextParam
						/SPNameNativ		ourSPName
					}
				}
			}
		}
		/EmpSalaryTest {
			/TheAction {
				/CallDA 	SPMaxSalary
			}
			/Result {
				/TmpStore {
					/SPMaxSalary {
						/Query	"BEGIN getempsalary(:ID,:SALARY); END;"
						/ID			7839
						/SALARY		5000
						/QuerySource	"//sifs-coast1.hsr.ch:1521/orcl"
					}
				}
			}
		}
		/GetFloatTest {
			/TmpStore {
				/SPName	getfloat
			}
			/TheAction {
				/CallDA 	SPExecute
			}
			/Result {
				/TmpStore {
					/SPExecute {
						/Query	"BEGIN getfloat(:RESULT); END;"
						/RESULT		3.14
						/QuerySource	"//sifs-coast1.hsr.ch:1521/orcl"
					}
				}
			}
		}
		/GetStringTest {
			/TmpStore {
				/SPName	getstring
			}
			/TheAction {
				/CallDA {
					/DataAccess	SPExecute
					/Parameters {
						/LOOPCOUNT	5
					}
				}
			}
			/Result {
				/TmpStore {
					/SPExecute {
						/Query	"BEGIN getstring(:LOOPCOUNT,:RESULT); END;"
						/RESULT		"aaaaa"
						/QuerySource	"//sifs-coast1.hsr.ch:1521/orcl"
					}
				}
			}
		}
		/GetStringTooShortTest {
			/UseConfig	GetStringTest
			/Replace {
				/TmpStore.StringBufferSize	4
				/Result.TmpStore.SPExecute {
					/Query	"BEGIN getstring(:LOOPCOUNT,:RESULT); END;"
					/QuerySource	"//sifs-coast1.hsr.ch:1521/orcl"
					/Messages {
						"OracleDAImpl::Error - ORA-06502: PL/SQL: numeric or value error: character string buffer too small\nORA-06512: at \"ORATEST.GETSTRING\", line 6\nORA-06512: at line 1\n"
					}
				}
				/ExpectedResult	0
			}
		}
		/GetStringDefaultMaxSizeTest {
			/UseConfig	GetStringTest
			/Replace {
				/TheAction.CallDA.Parameters.LOOPCOUNT	4096
				/Result.TmpStore.SPExecute.RESULT ignore
			}
		}
		/GetStringAboveMaxSizeTest {
			/UseConfig	GetStringTest
			/Replace {
				/TheAction.CallDA.Parameters.LOOPCOUNT	4097
				/Result.TmpStore.SPExecute {
					/Query	"BEGIN getstring(:LOOPCOUNT,:RESULT); END;"
					/QuerySource	"//sifs-coast1.hsr.ch:1521/orcl"
					/Messages {
						"OracleDAImpl::Error - ORA-06502: PL/SQL: numeric or value error: character string buffer too small\nORA-06512: at \"ORATEST.GETSTRING\", line 6\nORA-06512: at line 1\n"
					}
				}
				/ExpectedResult	0
			}
		}
	}
}
